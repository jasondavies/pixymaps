<!DOCTYPE html>
<html>
  <head>
    <script type="text/javascript" src="../../pixymaps.js"></script>
    <script type="text/javascript" src="../../lib/d3/d3.js"></script>
    <script type="text/javascript" src="../../lib/d3/d3.geo.js"></script>
    <style type="text/css">

body {
  font: 10px sans-serif;
}

#container {
  overflow: hidden;
}

    </style>
  </head>
  <body>
    <div id="container" style="width: 960px; height: 500px">
      <canvas id="map" width="1920" height="1000"></canvas>
    </div>
    <script type="text/javascript">

var map = d3.select("#map"),
    canvas = map.node(),
    context = canvas.getContext("2d");

var w = canvas.width,
    h = canvas.height,
    lon = -122.41948,
    lat = 37.76487;

var project = d3.geo.mercator()
    .scale(1)
    .translate([.5, .5]);

var view = pixymaps.view()
    .size([w, h])
    .center(project([lon, lat]))
    .zoom(12);

var image = pixymaps.image()
    .view(view)
    .url(pixymaps.url("http://{S}tile.cloudmade.com"
    + "/1a1b06b230af4efdbb989ea99e9841af" // http://cloudmade.com/register
    + "/999/256/{Z}/{X}/{Y}.png")
    .hosts(["a.", "b.", "c.", ""]));

var translate = [-480, -250];

var rendering = false;

var container = d3.select("#container")
    .on("mousedown", function() {
      var e = d3.event,
          m = [e.clientX, e.clientY],
          translate0 = translate.slice();
      d3.select(window)
        .on("mousemove", function() {
          var e = d3.event;
          translate[0] = translate0[0] + e.clientX - m[0];
          translate[1] = translate0[1] + e.clientY - m[1];
          redraw();
          // Re-blit
          var pan = [
            translate[0] >= 0 ? 480 : translate[0] < -960 ? -480 : 0,
            translate[1] >= 0 ? 250 : translate[1] < -500 ? -250 : 0
          ];
          if (!rendering && (pan[0] || pan[1])) {
            view.panBy(pan);
            rendering = true;
            image.render(context, function() {
              rendering = false;
              translate[0] -= pan[0];
              translate[1] -= pan[1];
              translate0[0] -= pan[0];
              translate0[1] -= pan[1];
              redraw();
            });
          }
        })
        .on("mouseup", function() {
          d3.select(window)
            .on("mousemove", null)
            .on("mouseup", null);
        });
    });

function redraw() {
  map.style("-webkit-transform",
    "translate(" + translate.join("px,") + "px)");
}

redraw();

image.render(context, function() {
  console.log("hooray");
});

    </script>
    <div id="copy">
      &copy; 2011
      <a href="http://www.cloudmade.com/">CloudMade</a>,
      <a href="http://www.openstreetmap.org/">OpenStreetMap</a> contributors,
      <a href="http://creativecommons.org/licenses/by-sa/2.0/">CCBYSA</a>.
    </div>
  </body>
</html>
